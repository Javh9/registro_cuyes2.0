<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Granja de Cuyes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-green-600 text-white p-4 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold text-center mb-2">
                <i class="fas fa-paw mr-3"></i>Granja de Cuyes - Sistema Integral
            </h1>
            <p class="text-center text-green-100">
                GestiÃ³n completa del ciclo productivo â€¢ {{ fecha_actual }}
            </p>
        </div>
    </div>

    <!-- NavegaciÃ³n -->
    <nav class="bg-white shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-center space-x-4 py-3">
                <a href="/partos" class="bg-green-100 text-green-800 px-4 py-2 rounded-lg hover:bg-green-200 transition flex items-center">
                    <i class="fas fa-baby mr-2"></i>Partos
                </a>
                <a href="/mortalidad_lactancia" class="bg-red-100 text-red-800 px-4 py-2 rounded-lg hover:bg-red-200 transition flex items-center">
                    <i class="fas fa-heart-crack mr-2"></i>Mortalidad
                </a>
                <a href="/destetes" class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg hover:bg-blue-200 transition flex items-center">
                    <i class="fas fa-baby mr-2"></i>Destetes
                </a>
                <a href="/ventas" class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg hover:bg-yellow-200 transition flex items-center">
                    <i class="fas fa-dollar-sign mr-2"></i>Ventas
                </a>
                <!-- En la secciÃ³n de navegaciÃ³n, DESPUÃ‰S de Ventas y ANTES de Galpones -->
                <a href="/balance" class="bg-purple-100 text-purple-800 px-4 py-2 rounded-lg hover:bg-purple-200 transition flex items-center">
                    <i class="fas fa-chart-bar mr-2"></i>Balance
                </a>
                <!-- En la navegaciÃ³n, agregar despuÃ©s de Inventario -->
                <a href="/predicciones" class="bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg hover:bg-indigo-200 transition flex items-center">
                    <i class="fas fa-crystal-ball mr-2"></i>Predicciones
                </a>
                <!-- En la secciÃ³n de navegaciÃ³n, agrega: -->
                <li class="mb-2">
                    <a href="{{ url_for('mortalidad_lactancia') }}" 
                    class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">
                     ðŸ’” Mortalidad Lactancia
                 </a>
                </li>
                <a href="/galpones" class="bg-purple-100 text-purple-800 px-4 py-2 rounded-lg hover:bg-purple-200 transition flex items-center">
                    <i class="fas fa-house mr-2"></i>Galpones
                </a>
                <a href="/gastos" class="bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg hover:bg-indigo-200 transition flex items-center">
                    <i class="fas fa-money-bill-wave mr-2"></i>Gastos
                </a>
                <a href="/inventario" class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition flex items-center">
                    <i class="fas fa-clipboard-list mr-2"></i>Inventario
                </a>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="container mx-auto p-6">
        <!-- MÃ©tricas Principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Animales -->
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Animales</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalAnimales">0</p>
                    </div>
                    <i class="fas fa-paw text-green-500 text-2xl"></i>
                </div>
                <p class="text-xs text-gray-500 mt-2">Inventario estimado</p>
            </div>

            <!-- Partos Este Mes -->
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Partos Este Mes</p>
                        <p class="text-2xl font-bold text-gray-800" id="partosMes">0</p>
                    </div>
                    <i class="fas fa-baby text-blue-500 text-2xl"></i>
                </div>
                <p class="text-xs text-gray-500 mt-2">Nacimientos registrados</p>
            </div>

            <!-- Ventas Este Mes -->
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Ventas Este Mes</p>
                        <p class="text-2xl font-bold text-gray-800" id="ventasMes">S/ 0.00</p>
                    </div>
                    <i class="fas fa-dollar-sign text-yellow-500 text-2xl"></i>
                </div>
                <p class="text-xs text-gray-500 mt-2">Ingresos del mes</p>
            </div>

            <!-- Balance Mensual -->
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Balance Mensual</p>
                        <p class="text-2xl font-bold text-gray-800" id="balanceMes">S/ 0.00</p>
                    </div>
                    <i class="fas fa-chart-line text-purple-500 text-2xl"></i>
                </div>
                <p class="text-xs text-gray-500 mt-2">Ventas - Gastos</p>
            </div>
        </div>

        <!-- Segunda Fila de MÃ©tricas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Destetes Este Mes -->
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-indigo-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Destetes Este Mes</p>
                        <p class="text-2xl font-bold text-gray-800" id="destetesMes">0</p>
                    </div>
                    <i class="fas fa-baby text-indigo-500 text-2xl"></i>
                </div>
                <p class="text-xs text-gray-500 mt-2">Animales destetados</p>
            </div>

            <!-- Mortalidad Este Mes -->
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Mortalidad Este Mes</p>
                        <p class="text-2xl font-bold text-gray-800" id="mortalidadMes">0</p>
                    </div>
                    <i class="fas fa-heart-crack text-red-500 text-2xl"></i>
                </div>
                <p class="text-xs text-gray-500 mt-2">En perÃ­odo de lactancia</p>
            </div>

            <!-- Gastos Este Mes -->
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Gastos Este Mes</p>
                        <p class="text-2xl font-bold text-gray-800" id="gastosMes">S/ 0.00</p>
                    </div>
                    <i class="fas fa-money-bill-wave text-orange-500 text-2xl"></i>
                </div>
                <p class="text-xs text-gray-500 mt-2">Egresos del mes</p>
            </div>
        </div>

        <!-- GrÃ¡ficos y Alertas -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- GrÃ¡fico de ProducciÃ³n -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">
                    <i class="fas fa-chart-line mr-2"></i>Tendencias de ProducciÃ³n
                </h3>
                <div class="h-64">
                    <canvas id="produccionChart"></canvas>
                </div>
            </div>

            <!-- GrÃ¡fico de Ventas -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">
                    <i class="fas fa-dollar-sign mr-2"></i>Ventas Mensuales
                </h3>
                <div class="h-64">
                    <canvas id="ventasChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Alertas y Actividad Reciente -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Ãšltimos Partos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">
                    <i class="fas fa-baby mr-2"></i>Ãšltimos Partos Registrados
                </h3>
                <div id="ultimosPartos" class="space-y-3">
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Cargando...
                    </div>
                </div>
            </div>

            <!-- Alertas de Mortalidad -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Alertas Recientes
                </h3>
                <div id="alertasMortalidad" class="space-y-3">
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Cargando...
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones RÃ¡pidas -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
                <i class="fas fa-bolt mr-2"></i>Acciones RÃ¡pidas
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="/partos" class="bg-green-100 hover:bg-green-200 text-green-800 p-4 rounded-lg text-center transition flex flex-col items-center">
                    <i class="fas fa-baby text-2xl mb-2"></i>
                    <span class="font-medium">Registrar Parto</span>
                </a>
                
                <a href="/mortalidad_lactancia" class="bg-red-100 hover:bg-red-200 text-red-800 p-4 rounded-lg text-center transition flex flex-col items-center">
                    <i class="fas fa-heart-crack text-2xl mb-2"></i>
                    <span class="font-medium">Registrar Mortalidad</span>
                </a>
                
                <a href="/destetes" class="bg-blue-100 hover:bg-blue-200 text-blue-800 p-4 rounded-lg text-center transition flex flex-col items-center">
                    <i class="fas fa-baby text-2xl mb-2"></i>
                    <span class="font-medium">Registrar Destete</span>
                </a>
                
                <a href="/ventas" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 p-4 rounded-lg text-center transition flex flex-col items-center">
                    <i class="fas fa-dollar-sign text-2xl mb-2"></i>
                    <span class="font-medium">Registrar Venta</span>
                </a>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Variables globales para los grÃ¡ficos
        let produccionChart, ventasChart;

        document.addEventListener('DOMContentLoaded', function() {
            cargarDashboard();
            setInterval(cargarDashboard, 30000); // Actualizar cada 30 segundos
        });

        function cargarDashboard() {
            fetch('/api/dashboard/estadisticas')
                .then(response => response.json())
                .then(data => {
                    actualizarMetricas(data);
                    actualizarAlertas(data);
                })
                .catch(error => {
                    console.error('Error cargando dashboard:', error);
                });

            fetch('/api/dashboard/tendencias')
                .then(response => response.json())
                .then(data => {
                    actualizarGraficos(data);
                })
                .catch(error => {
                    console.error('Error cargando tendencias:', error);
                });
        }

        function actualizarMetricas(data) {
            document.getElementById('totalAnimales').textContent = data.total_animales;
            document.getElementById('partosMes').textContent = data.partos_mes;
            document.getElementById('mortalidadMes').textContent = data.mortalidad_mes;
            document.getElementById('destetesMes').textContent = data.destetes_mes;
            document.getElementById('ventasMes').textContent = `S/ ${data.ventas_mes.toFixed(2)}`;
            document.getElementById('gastosMes').textContent = `S/ ${data.gastos_mes.toFixed(2)}`;
            
            const balance = data.ventas_mes - data.gastos_mes;
            document.getElementById('balanceMes').textContent = `S/ ${balance.toFixed(2)}`;
            
            // Color del balance segÃºn si es positivo o negativo
            const balanceElement = document.getElementById('balanceMes');
            if (balance >= 0) {
                balanceElement.classList.remove('text-red-800');
                balanceElement.classList.add('text-green-800');
            } else {
                balanceElement.classList.remove('text-green-800');
                balanceElement.classList.add('text-red-800');
            }
        }

        function actualizarAlertas(data) {
            // Ãšltimos partos
            const partosContainer = document.getElementById('ultimosPartos');
            if (data.ultimos_partos && data.ultimos_partos.length > 0) {
                partosContainer.innerHTML = data.ultimos_partos.map(parto => `
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="flex-1">
                            <div class="font-medium text-green-800">${parto.galpon} - ${parto.poza}</div>
                            <div class="text-sm text-green-600">${parto.nacidos} nacidos â€¢ ${parto.fecha}</div>
                        </div>
                        <div class="bg-green-500 text-white rounded-full p-2">
                            <i class="fas fa-baby"></i>
                        </div>
                    </div>
                `).join('');
            } else {
                partosContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-info-circle mr-2"></i>No hay partos recientes
                    </div>
                `;
            }

            // Alertas de mortalidad
            const alertasContainer = document.getElementById('alertasMortalidad');
            if (data.alertas_mortalidad && data.alertas_mortalidad.length > 0) {
                alertasContainer.innerHTML = data.alertas_mortalidad.map(alerta => `
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                        <div class="flex-1">
                            <div class="font-medium text-red-800">${alerta.galpon}</div>
                            <div class="text-sm text-red-600">${alerta.cantidad} muertos â€¢ ${alerta.causa} â€¢ ${alerta.fecha}</div>
                        </div>
                        <div class="bg-red-500 text-white rounded-full p-2">
                            <i class="fas fa-heart-crack"></i>
                        </div>
                    </div>
                `).join('');
            } else {
                alertasContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-check-circle mr-2"></i>No hay alertas de mortalidad
                    </div>
                `;
            }
        }

        function actualizarGraficos(data) {
            // GrÃ¡fico de producciÃ³n
            const ctxProduccion = document.getElementById('produccionChart').getContext('2d');
            const meses = data.partos_mensuales?.map(item => item.mes) || [];
            const partos = data.partos_mensuales?.map(item => item.total) || [];

            if (produccionChart) {
                produccionChart.destroy();
            }

            produccionChart = new Chart(ctxProduccion, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Partos Mensuales',
                        data: partos,
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });

            // GrÃ¡fico de ventas
            const ctxVentas = document.getElementById('ventasChart').getContext('2d');
            const ventasMeses = data.ventas_mensuales?.map(item => item.mes) || [];
            const ventas = data.ventas_mensuales?.map(item => item.total) || [];

            if (ventasChart) {
                ventasChart.destroy();
            }

            ventasChart = new Chart(ctxVentas, {
                type: 'bar',
                data: {
                    labels: ventasMeses,
                    datasets: [{
                        label: 'Ventas (S/)',
                        data: ventas,
                        backgroundColor: 'rgba(234, 179, 8, 0.8)',
                        borderColor: 'rgba(234, 179, 8, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S/ ' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>